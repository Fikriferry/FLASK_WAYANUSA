<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengenalan Wayang - WAYANUSA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    {% include "partials/navbar.html" %}

    <section class="wayang-recognition" style="padding-top: 100px;">
        <div class="recognition-wrapper">

            <div class="recognition-header">
                <div class="back-btn-wrapper">
                    <button class="back-btn" onclick="goBack()" title="Kembali">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <h1 class="recognition-title">Identifikasi Wayang AI</h1>
                <p style="color: #bbb; margin-top: 10px;">Gunakan teknologi AI untuk mengenali tokoh wayang favoritmu
                </p>
            </div>

            <div class="recognition-card" id="recognitionCard">
                <div class="progress-indicator">
                    <div class="progress-step">
                        <div class="step-circle" id="step1">1</div>
                    </div>
                    <div class="step-line" id="line1"></div>

                    <div class="progress-step">
                        <div class="step-circle" id="step2">2</div>
                    </div>
                    <div class="step-line" id="line2"></div>

                    <div class="progress-step">
                        <div class="step-circle" id="step3">3</div>
                    </div>
                    <div class="step-line" id="line3"></div>

                    <div class="progress-step">
                        <div class="step-circle" id="step4">4</div>
                    </div>
                </div>

                <div class="stage-content" id="stageContent">

                    <div id="stage1" class="fade-in-up"
                        style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                        <h3 style="margin-bottom: 30px; color: #6B4226;">Pilih Metode Pengambilan Gambar</h3>
                        <div class="selection-grid">
                            <div class="selection-card" onclick="selectMethod('camera')">
                                <div class="selection-icon"><i class="fas fa-camera"></i></div>
                                <div class="selection-title">Gunakan Kamera</div>
                                <div class="selection-desc">Ambil foto langsung dari kamera perangkatmu</div>
                            </div>
                            <div class="selection-card" onclick="selectMethod('upload')">
                                <div class="selection-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                                <div class="selection-title">Upload File</div>
                                <div class="selection-desc">Pilih foto dari galeri (JPG/PNG)</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </section>

    <script>
        // --- 1. SETUP VARIABEL GLOBAL ---
        let currentStage = 1;
        let selectedMethod = null;
        let selectedFile = null;
        let previewUrl = null;

        // --- 2. DATABASE DESKRIPSI ---
        const wayangData = {
            "Abimanyu": "Putra Arjuna yang dikenal sebagai ksatria muda pemberani dan ahli strategi perang. Ia gugur secara heroik di medan perang Baratayuda saat dikeroyok Kurawa.",
            "Anoman": "Kera putih sakti mandraguna, putra Batara Guru. Ia adalah abdi setia Sri Rama dalam kisah Ramayana dan memiliki umur panjang hingga era Mahabharata.",
            "Arjuna": "Putra ketiga Pandawa yang berparas tampan dan lemah lembut. Ia adalah pemanah ulung pemilik panah Pasopati dan penengah Pandawa.",
            "Bagong": "Punakawan bungsu anak Semar. Bertubuh gemuk, bermata lebar, dan lucu. Sifatnya lugu, ceplas-ceplos, dan sering melontarkan kritik jenaka.",
            "Baladewa": "Kakak Prabu Kresna, Raja Mandura. Berwatak keras dan mudah marah, namun sangat jujur dan adil. Senjata andalannya adalah Nanggala.",
            "Bima": "Putra kedua Pandawa (Werkudara). Bertubuh tinggi besar, kuku Pancanaka, dan Gada Rujakpala. Sifatnya jujur, tegas, dan tidak basa-basi.",
            "Buta": "Istilah umum untuk Raksasa dalam pewayangan. Menggambarkan sifat angkara murka, kasar, dan menjadi musuh para ksatria.",
            "Cakil": "Tokoh raksasa dengan rahang bawah menonjol (cameh). Ia sangat lincah, namun melambangkan sifat pantang menyerah di jalan yang salah.",
            "Durna": "Guru besar ilmu perang Pandawa dan Kurawa. Sangat sakti namun sering berpihak pada Kurawa karena politik dan sumpah setianya pada negara Hastina.",
            "Dursasana": "Adik Duryudana yang berbadan gagah namun bermulut besar dan kasar. Ia melambangkan kesewenang-wenangan.",
            "Duryudana": "Raja Hastinapura dan pemimpin Kurawa. Wataknya angkuh, keras kepala, dan mudah terhasut oleh Sengkuni untuk memusuhi Pandawa.",
            "Gareng": "Anak tertua Semar. Kakinya pincang dan tangannya ceko, melambangkan kehati-hatian dalam melangkah dan tidak suka mengambil hak orang lain.",
            "Gatotkaca": "Putra Bima, ksatria Pringgandani. Dikenal dengan 'Otot kawat tulang besi', bisa terbang, dan menjadi pelindung Pandawa.",
            "Karna": "Kakak tertua Pandawa yang berada di pihak Kurawa. Pemanah sakti yang setara dengan Arjuna, dikenal sangat dermawan dan setia kawan.",
            "Kresna": "Raja Dwarawati, titisan Dewa Wisnu. Penasihat utama Pandawa yang bijaksana, ahli strategi ulung, dan pemilik senjata Cakra.",
            "Nakula Sadewa": "Putra kembar Pandawa. Nakula ahli merawat kuda dan sangat tampan, sedangkan Sadewa ahli perbintangan dan bijaksana.",
            "Patih Sabrang": "Sebutan untuk patih dari kerajaan seberang (luar Jawa/raksasa). Biasanya digambarkan gagah, brangasan, dan menjadi musuh.",
            "Petruk": "Anak kedua Semar. Berbadan tinggi, hidung panjang, dan selalu tersenyum. Ia cerdas, humoris, dan suka menyindir ketidakadilan.",
            "Puntadewa": "Putra tertua Pandawa (Yudhistira). Berdarah putih (suci), tidak pernah berbohong, sangat sabar, dan tidak memiliki musuh.",
            "Semar": "Tokoh punakawan utama, pengasuh para ksatria. Sejatinya adalah dewa (Batara Ismaya) yang turun ke bumi. Simbol kebijaksanaan rakyat.",
            "Sengkuni": "Patih Hastinapura yang licik. Ia adalah dalang di balik permusuhan Pandawa dan Kurawa, ahli siasat buruk dan adu domba.",
            "Togog": "Kakak Semar yang memihak pada musuh (raksasa). Tugasnya menasihati majikan yang jahat agar kembali ke jalan benar, meski jarang didengar."
        };

        function goBack() {
            window.history.back();
        }

        // --- 3. PILIH METODE & UPDATE UI ---
        function selectMethod(method) {
            // Cek Login Session (Template Jinja)
            const isLoggedIn = {{ session.get('user_logged_in', False) | tojson
        }};
        if (!isLoggedIn) {
            alert('Silakan login terlebih dahulu untuk menggunakan fitur ini.');
            window.location.href = "{{ url_for('web.login_user') }}";
            return;
        }

        selectedMethod = method;
        selectedFile = null;

        if (selectedMethod === 'camera') {
            showStage2();
        } else if (selectedMethod === 'upload') {
            showStage3();
        }
        }

        function updateProgress(stage) {
            currentStage = stage;
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(step${i});
                const line = document.getElementById(line${i});

                step.className = 'step-circle';
                if (line) line.className = 'step-line';

                if (i < currentStage) {
                    step.classList.add('completed');
                    if (line) line.classList.add('completed');
                } else if (i === currentStage) {
                    step.classList.add('active');
                    if (line) line.classList.add('active');
                }
            }
        }

        // --- STAGE 2: CAMERA UI (SIMULASI) ---
        function showStage2() {
            updateProgress(2);
            const stageContent = document.getElementById('stageContent');
            stageContent.innerHTML = `
                <div class="fade-in-up" style="display:flex; flex-direction:column; align-items:center;">
                    <div class="camera-frame">
                        <div class="scanner-line"></div>
                        <div style="width:100%; height:100%; background: #222; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-video" style="color:#444; font-size:3rem;"></i>
                        </div>
                        <div class="camera-overlay">
                            <button class="shutter-btn" onclick="capturePhoto()" title="Ambil Foto"></button>
                        </div>
                    </div>
                    <p style="margin-top:15px; color:#666; font-size:0.9rem;">Posisikan wayang di dalam bingkai</p>
                    <button onclick="resetToStage1()" class="action-btn btn-secondary" style="margin-top:10px;">Kembali</button>
                </div>
            `;
        }

        function capturePhoto() {
            // Simulasi Fetch Gambar
            fetch("https://via.placeholder.com/300x400/D4A373/FFFFFF?text=Wayang+Capture")
                .then(res => res.blob())
                .then(blob => {
                    selectedFile = new File([blob], "capture.jpg", { type: "image/jpeg" });
                    previewUrl = URL.createObjectURL(blob);
                    showPreviewStage();
                });
        }

        // --- STAGE 3: UPLOAD UI ---
        // --- REVISI: STAGE 3 (FIX BUG UPLOAD) ---
        function showStage3() {
            updateProgress(3);

            const stageContent = document.getElementById('stageContent');

            // PERBAIKAN:
            // 1. Mengganti <div> menjadi <label>
            // 2. Menambahkan atribut 'for="fileInput"'
            // 3. Menghapus 'onclick="..."' karena <label> otomatis memicu input di dalamnya

            stageContent.innerHTML = `
                <div class="fade-in-up" style="width:100%; display:flex; flex-direction:column; align-items:center;">
                    
                    <label class="upload-zone" for="fileInput">
                        <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                        <div class="upload-text">Klik untuk Upload Foto</div>
                        <div class="upload-subtext">JPG, PNG (Max 5MB)</div>
                        
                        <input type="file" id="fileInput" class="file-input" accept="image/*" 
                               onclick="this.value=null" 
                               onchange="handleFileUpload(event)">
                    </label>

                    <button onclick="resetToStage1()" class="action-btn btn-secondary" style="margin-top:20px;">Kembali</button>
                </div>
            `;
        }

        // --- REVISI: HANDLE FILE (LEBIH AMAN) ---
        function handleFileUpload(event) {
            // Cek apakah ada file yang dipilih
            if (event.target.files && event.target.files.length > 0) {
                const file = event.target.files[0];

                // Validasi tipe file (Opsional tapi disarankan)
                if (!file.type.startsWith('image/')) {
                    alert('Mohon upload file gambar (JPG/PNG).');
                    return;
                }

                selectedFile = file;
                previewUrl = URL.createObjectURL(file);

                // Langsung lanjut ke preview
                showPreviewStage();
            }
        }

        // --- PREVIEW / CONFIRMATION ---
        function showPreviewStage() {
            updateProgress(3); // Dianggap tahap konfirmasi
            const stageContent = document.getElementById('stageContent');
            stageContent.innerHTML = `
                <div class="fade-in-up" style="display:flex; flex-direction:column; align-items:center;">
                    <div class="preview-container">
                        <img src="${previewUrl}" class="image-preview" alt="Preview">
                    </div>
                    <h4 style="margin-top:20px; color:#444;">Apakah foto sudah jelas?</h4>
                    <div style="display:flex; gap:15px;">
                        <button class="action-btn btn-secondary" onclick="resetToStage1()">Ulangi</button>
                        <button class="action-btn btn-primary" onclick="processImage()">
                            <i class="fas fa-search"></i> Analisis Sekarang
                        </button>
                    </div>
                </div>
            `;
        }

        function resetToStage1() {
            updateProgress(1);
            document.getElementById('stageContent').innerHTML = `
                <div id="stage1" class="fade-in-up" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                    <h3 style="margin-bottom: 30px; color: #6B4226;">Pilih Metode Pengambilan Gambar</h3>
                    <div class="selection-grid">
                        <div class="selection-card" onclick="selectMethod('camera')">
                            <div class="selection-icon"><i class="fas fa-camera"></i></div>
                            <div class="selection-title">Gunakan Kamera</div>
                            <div class="selection-desc">Ambil foto langsung dari kamera perangkatmu</div>
                        </div>
                        <div class="selection-card" onclick="selectMethod('upload')">
                            <div class="selection-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                            <div class="selection-title">Upload File</div>
                            <div class="selection-desc">Pilih foto dari galeri (JPG/PNG)</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- CONNECT TO API ---
        async function processImage() {
            if (!selectedFile) return;

            // Loading UI
            const stageContent = document.getElementById('stageContent');
            stageContent.innerHTML = `
                <div class="fade-in-up" style="text-align: center; padding:40px;">
                    <div style="width: 60px; height: 60px; border: 5px solid #f3f3f3; border-top: 5px solid #D4A373; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    <h3 style="color: #6B4226; margin-top: 20px;">AI Sedang Berpikir...</h3>
                    <p style="color: #888;">Menganalisis pola wayang</p>
                </div>
            `;

            const formData = new FormData();
            formData.append('image', selectedFile);

            try {
                const response = await fetch('/api/predict-wayang', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    showResult(data);
                } else {
                    alert("Error: " + (data.error || "Gagal"));
                    resetToStage1();
                }
            } catch (error) {
                console.error("API Error", error);
                alert("Koneksi Error");
                resetToStage1();
            }
        }

        // --- STAGE 4: RESULT ---
        function showResult(data) {
            updateProgress(4);
            const namaWayang = data.prediksi;
            const confidence = data.confidence;
            const deskripsi = wayangData[namaWayang] || `Tokoh ${namaWayang} berhasil terdeteksi, namun deskripsi detail belum tersedia di database.`;

            const stageContent = document.getElementById('stageContent');
            stageContent.innerHTML = `
                <div class="result-layout fade-in-up">
                    <div class="result-img-wrapper">
                        <img src="${previewUrl}" class="result-img" alt="${namaWayang}">
                    </div>
                    <div class="result-info">
                        <span class="confidence-badge"><i class="fas fa-check-circle"></i> Akurasi: ${confidence}</span>
                        <h2 class="wayang-name">${namaWayang}</h2>
                        <div class="wayang-desc">
                            ${deskripsi}
                        </div>
                        <button class="action-btn btn-primary" onclick="resetToStage1()">
                            <i class="fas fa-redo"></i> Coba Lagi
                        </button>
                    </div>
                </div>
            `;
        }

        // Add Spin Animation
        const style = document.createElement('style');
        style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
        document.head.appendChild(style);
    </script>
</body>

</html>