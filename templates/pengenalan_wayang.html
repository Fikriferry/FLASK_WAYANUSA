<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengenalan Wayang - WAYANUSA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* --- GLOBAL & BACKGROUND --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
        }

        .wayang-recognition {
            min-height: 100vh;
            background: radial-gradient(circle at top right, #3d2b1f 0%, #1a1a1a 40%, #000000 100%);
            padding: 40px 0;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- CONTAINER UTAMA --- */
        .recognition-wrapper {
            width: 100%;
            max-width: 900px;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        /* --- HEADER SECTION --- */
        .recognition-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .back-btn-wrapper {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #D4A373;
            border: 1px solid rgba(212, 163, 115, 0.3);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .back-btn:hover {
            background: #D4A373;
            color: #fff;
            transform: scale(1.1);
        }

        .recognition-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            background: linear-gradient(to right, #D4A373, #F3E5AB, #D4A373);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            font-weight: 700;
            letter-spacing: 1px;
        }

        /* --- MAIN CARD --- */
        .recognition-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(212, 163, 115, 0.3);
            position: relative;
            overflow: hidden;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }

        /* Hiasan Batik Halus di Header Card */
        .recognition-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #6B4226, #D4A373, #6B4226);
        }

        /* --- PROGRESS BAR --- */
        .progress-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
            position: relative;
        }

        .progress-step {
            z-index: 2;
        }

        .step-circle {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #f0f0f0;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #e0e0e0;
        }

        .step-circle.active {
            background: #D4A373;
            color: white;
            border-color: #D4A373;
            box-shadow: 0 0 15px rgba(212, 163, 115, 0.5);
            transform: scale(1.1);
        }

        .step-circle.completed {
            background: #6B4226;
            color: white;
            border-color: #6B4226;
        }

        .step-line {
            width: 60px;
            height: 3px;
            background: #e0e0e0;
            margin: 0 5px;
            transition: all 0.4s ease;
            border-radius: 2px;
        }

        .step-line.active,
        .step-line.completed {
            background: linear-gradient(90deg, #6B4226, #D4A373);
        }

        /* --- STAGE CONTENT AREA --- */
        .stage-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        /* --- STAGE 1: SELECTION CARDS --- */
        .selection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 600px;
        }

        .selection-card {
            background: #fff;
            border: 2px solid #f0f0f0;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .selection-card:hover {
            border-color: #D4A373;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(212, 163, 115, 0.2);
        }

        .selection-icon {
            font-size: 3rem;
            color: #6B4226;
            margin-bottom: 15px;
        }

        .selection-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .selection-desc {
            font-size: 0.85rem;
            color: #777;
        }

        /* --- STAGE 2: CAMERA UI --- */
        .camera-frame {
            width: 100%;
            max-width: 450px;
            height: 350px;
            background: #000;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            border: 4px solid #333;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Scanner Animation */
        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
            animation: scan 2s linear infinite;
            z-index: 5;
        }

        .camera-overlay {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 10;
        }

        .shutter-btn {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .shutter-btn:active {
            transform: scale(0.9);
            background: #ddd;
        }

        /* --- STAGE 3: UPLOAD UI --- */
        .upload-zone {
            width: 100%;
            max-width: 500px;
            height: 300px;
            border: 3px dashed #D4A373;
            border-radius: 20px;
            background: #FBEDE3;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-zone:hover {
            background: #F5DEC9;
            transform: scale(1.02);
        }

        /* --- PREVIEW IMAGE --- */
        .preview-container {
            position: relative;
            padding: 10px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transform: rotate(-2deg);
            /* Artistic tilt */
        }

        .image-preview {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            object-fit: cover;
            border: 1px solid #ddd;
        }

        /* --- STAGE 4: RESULT --- */
        .result-layout {
            display: flex;
            flex-direction: row;
            gap: 30px;
            text-align: left;
            width: 100%;
            align-items: flex-start;
        }

        .result-img-wrapper {
            flex: 0 0 150px;
        }

        .result-img {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 3px solid #D4A373;
        }

        .result-info {
            flex: 1;
        }

        .confidence-badge {
            display: inline-block;
            background: #e6f4ea;
            color: #1e8e3e;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .wayang-name {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: #6B4226;
            margin: 0 0 15px 0;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .wayang-desc {
            font-size: 0.95rem;
            line-height: 1.7;
            color: #555;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #D4A373;
        }

        /* --- BUTTONS --- */
        .action-btn {
            padding: 12px 30px;
            border-radius: 30px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #D4A373 0%, #B88656 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(212, 163, 115, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 163, 115, 0.6);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* --- ANIMATIONS --- */
        @keyframes scan {
            0% {
                top: 0;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.5s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .selection-grid {
                grid-template-columns: 1fr;
            }

            .result-layout {
                flex-direction: column;
                text-align: center;
                align-items: center;
            }

            .result-img-wrapper {
                width: 150px;
                margin-bottom: 20px;
            }

            .wayang-desc {
                text-align: left;
            }

            .step-line {
                width: 30px;
            }

            .recognition-title {
                font-size: 1.8rem;
            }

            .back-btn-wrapper {
                position: static;
                margin-bottom: 20px;
                display: flex;
                justify-content: center;
                transform: none;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <div class="navbar-logo">
                    <a href="{{ url_for('web.home') }}" class="logo-link">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="WAYANUSA Logo"
                            class="logo-image">
                    </a>
                </div>
                <div class="navbar-menu">
                    <ul class="nav-links">
                        <li><a href="{{ url_for('web.pengenalan_wayang') }}">Pengenalan Wayang</a></li>
                        <li><a href="{{ url_for('web.quiz') }}">Quiz</a></li>
                        <li><a href="{{ url_for('web.mencari_dalang') }}">Mencari Dalang</a></li>
                        <li><a href="{{ url_for('web.pertunjukan_wayang') }}">Pertunjukan Wayang</a></li>
                    </ul>
                </div>
                <div class="navbar-actions">
                    {% if session.get('user_logged_in') %}
                    <span class="user-greeting">Halo, {{ session.get('user_name', 'User') }}!</span>
                    <a href="{{ url_for('web.logout_user') }}" class="btn-login">Logout</a>
                    {% else %}
                    <a href="{{ url_for('web.login_user') }}" class="btn-login">Login</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <section class="wayang-recognition" style="padding-top: 100px;">
        <div class="recognition-wrapper">

            <div class="recognition-header">
                <div class="back-btn-wrapper">
                    <button class="back-btn" onclick="goBack()" title="Kembali">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <h1 class="recognition-title">Identifikasi Wayang AI</h1>
                <p style="color: #bbb; margin-top: 10px;">Gunakan teknologi AI untuk mengenali tokoh wayang favoritmu
                </p>
            </div>

            <div class="recognition-card" id="recognitionCard">
                <div class="progress-indicator">
                    <div class="progress-step">
                        <div class="step-circle" id="step1">1</div>
                    </div>
                    <div class="step-line" id="line1"></div>

                    <div class="progress-step">
                        <div class="step-circle" id="step2">2</div>
                    </div>
                    <div class="step-line" id="line2"></div>

                    <div class="progress-step">
                        <div class="step-circle" id="step3">3</div>
                    </div>
                    <div class="step-line" id="line3"></div>

                    <div class="progress-step">
                        <div class="step-circle" id="step4">4</div>
                    </div>
                </div>

                <div class="stage-content" id="stageContent">

                    <div id="stage1" class="fade-in-up"
                        style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                        <h3 style="margin-bottom: 30px; color: #6B4226;">Pilih Metode Pengambilan Gambar</h3>
                        <div class="selection-grid">
                            <div class="selection-card" onclick="selectMethod('camera')">
                                <div class="selection-icon"><i class="fas fa-camera"></i></div>
                                <div class="selection-title">Gunakan Kamera</div>
                                <div class="selection-desc">Ambil foto langsung dari kamera perangkatmu</div>
                            </div>
                            <div class="selection-card" onclick="selectMethod('upload')">
                                <div class="selection-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                                <div class="selection-title">Upload File</div>
                                <div class="selection-desc">Pilih foto dari galeri (JPG/PNG)</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </section>

    <script>
        // --- 1. SETUP VARIABEL GLOBAL ---
        let currentStage = 1;
        let selectedMethod = null;
        let selectedFile = null;
        let previewUrl = null;

        // --- 2. DATABASE DESKRIPSI ---
        const wayangData = {
            "Abimanyu": "Putra Arjuna yang dikenal sebagai ksatria muda pemberani dan ahli strategi perang. Ia gugur secara heroik di medan perang Baratayuda saat dikeroyok Kurawa.",
            "Anoman": "Kera putih sakti mandraguna, putra Batara Guru. Ia adalah abdi setia Sri Rama dalam kisah Ramayana dan memiliki umur panjang hingga era Mahabharata.",
            "Arjuna": "Putra ketiga Pandawa yang berparas tampan dan lemah lembut. Ia adalah pemanah ulung pemilik panah Pasopati dan penengah Pandawa.",
            "Bagong": "Punakawan bungsu anak Semar. Bertubuh gemuk, bermata lebar, dan lucu. Sifatnya lugu, ceplas-ceplos, dan sering melontarkan kritik jenaka.",
            "Baladewa": "Kakak Prabu Kresna, Raja Mandura. Berwatak keras dan mudah marah, namun sangat jujur dan adil. Senjata andalannya adalah Nanggala.",
            "Bima": "Putra kedua Pandawa (Werkudara). Bertubuh tinggi besar, kuku Pancanaka, dan Gada Rujakpala. Sifatnya jujur, tegas, dan tidak basa-basi.",
            "Buta": "Istilah umum untuk Raksasa dalam pewayangan. Menggambarkan sifat angkara murka, kasar, dan menjadi musuh para ksatria.",
            "Cakil": "Tokoh raksasa dengan rahang bawah menonjol (cameh). Ia sangat lincah, namun melambangkan sifat pantang menyerah di jalan yang salah.",
            "Durna": "Guru besar ilmu perang Pandawa dan Kurawa. Sangat sakti namun sering berpihak pada Kurawa karena politik dan sumpah setianya pada negara Hastina.",
            "Dursasana": "Adik Duryudana yang berbadan gagah namun bermulut besar dan kasar. Ia melambangkan kesewenang-wenangan.",
            "Duryudana": "Raja Hastinapura dan pemimpin Kurawa. Wataknya angkuh, keras kepala, dan mudah terhasut oleh Sengkuni untuk memusuhi Pandawa.",
            "Gareng": "Anak tertua Semar. Kakinya pincang dan tangannya ceko, melambangkan kehati-hatian dalam melangkah dan tidak suka mengambil hak orang lain.",
            "Gatotkaca": "Putra Bima, ksatria Pringgandani. Dikenal dengan 'Otot kawat tulang besi', bisa terbang, dan menjadi pelindung Pandawa.",
            "Karna": "Kakak tertua Pandawa yang berada di pihak Kurawa. Pemanah sakti yang setara dengan Arjuna, dikenal sangat dermawan dan setia kawan.",
            "Kresna": "Raja Dwarawati, titisan Dewa Wisnu. Penasihat utama Pandawa yang bijaksana, ahli strategi ulung, dan pemilik senjata Cakra.",
            "Nakula Sadewa": "Putra kembar Pandawa. Nakula ahli merawat kuda dan sangat tampan, sedangkan Sadewa ahli perbintangan dan bijaksana.",
            "Patih Sabrang": "Sebutan untuk patih dari kerajaan seberang (luar Jawa/raksasa). Biasanya digambarkan gagah, brangasan, dan menjadi musuh.",
            "Petruk": "Anak kedua Semar. Berbadan tinggi, hidung panjang, dan selalu tersenyum. Ia cerdas, humoris, dan suka menyindir ketidakadilan.",
            "Puntadewa": "Putra tertua Pandawa (Yudhistira). Berdarah putih (suci), tidak pernah berbohong, sangat sabar, dan tidak memiliki musuh.",
            "Semar": "Tokoh punakawan utama, pengasuh para ksatria. Sejatinya adalah dewa (Batara Ismaya) yang turun ke bumi. Simbol kebijaksanaan rakyat.",
            "Sengkuni": "Patih Hastinapura yang licik. Ia adalah dalang di balik permusuhan Pandawa dan Kurawa, ahli siasat buruk dan adu domba.",
            "Togog": "Kakak Semar yang memihak pada musuh (raksasa). Tugasnya menasihati majikan yang jahat agar kembali ke jalan benar, meski jarang didengar."
        };

        function goBack() {
            window.history.back();
        }

        // --- 3. PILIH METODE & UPDATE UI ---
        function selectMethod(method) {
            // Cek Login Session (Template Jinja)
            const isLoggedIn = {{ session.get('user_logged_in', False) | tojson
        }};
        if (!isLoggedIn) {
            alert('Silakan login terlebih dahulu untuk menggunakan fitur ini.');
            window.location.href = "{{ url_for('web.login_user') }}";
            return;
        }

        selectedMethod = method;
        selectedFile = null;

        if (selectedMethod === 'camera') {
            showStage2();
        } else if (selectedMethod === 'upload') {
            showStage3();
        }
        }

        function updateProgress(stage) {
            currentStage = stage;
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                const line = document.getElementById(`line${i}`);

                step.className = 'step-circle';
                if (line) line.className = 'step-line';

                if (i < currentStage) {
                    step.classList.add('completed');
                    if (line) line.classList.add('completed');
                } else if (i === currentStage) {
                    step.classList.add('active');
                    if (line) line.classList.add('active');
                }
            }
        }

        // --- STAGE 2: CAMERA UI (SIMULASI) ---
        function showStage2() {
            updateProgress(2);
            const stageContent = document.getElementById('stageContent');
            stageContent.innerHTML = `
                <div class="fade-in-up" style="display:flex; flex-direction:column; align-items:center;">
                    <div class="camera-frame">
                        <div class="scanner-line"></div>
                        <div style="width:100%; height:100%; background: #222; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-video" style="color:#444; font-size:3rem;"></i>
                        </div>
                        <div class="camera-overlay">
                            <button class="shutter-btn" onclick="capturePhoto()" title="Ambil Foto"></button>
                        </div>
                    </div>
                    <p style="margin-top:15px; color:#666; font-size:0.9rem;">Posisikan wayang di dalam bingkai</p>
                    <button onclick="resetToStage1()" class="action-btn btn-secondary" style="margin-top:10px;">Kembali</button>
                </div>
            `;
        }

        function capturePhoto() {
            // Simulasi Fetch Gambar
            fetch("https://via.placeholder.com/300x400/D4A373/FFFFFF?text=Wayang+Capture")
                .then(res => res.blob())
                .then(blob => {
                    selectedFile = new File([blob], "capture.jpg", { type: "image/jpeg" });
                    previewUrl = URL.createObjectURL(blob);
                    showPreviewStage();
                });
        }

        // --- STAGE 3: UPLOAD UI ---
        // --- REVISI: STAGE 3 (FIX BUG UPLOAD) ---
        function showStage3() {
            updateProgress(3);

            const stageContent = document.getElementById('stageContent');

            // PERBAIKAN:
            // 1. Mengganti <div> menjadi <label>
            // 2. Menambahkan atribut 'for="fileInput"'
            // 3. Menghapus 'onclick="..."' karena <label> otomatis memicu input di dalamnya

            stageContent.innerHTML = `
                <div class="fade-in-up" style="width:100%; display:flex; flex-direction:column; align-items:center;">
                    
                    <label class="upload-zone" for="fileInput">
                        <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                        <div class="upload-text">Klik untuk Upload Foto</div>
                        <div class="upload-subtext">JPG, PNG (Max 5MB)</div>
                        
                        <input type="file" id="fileInput" class="file-input" accept="image/*" 
                               onclick="this.value=null" 
                               onchange="handleFileUpload(event)">
                    </label>

                    <button onclick="resetToStage1()" class="action-btn btn-secondary" style="margin-top:20px;">Kembali</button>
                </div>
            `;
        }

        // --- REVISI: HANDLE FILE (LEBIH AMAN) ---
        function handleFileUpload(event) {
            // Cek apakah ada file yang dipilih
            if (event.target.files && event.target.files.length > 0) {
                const file = event.target.files[0];

                // Validasi tipe file (Opsional tapi disarankan)
                if (!file.type.startsWith('image/')) {
                    alert('Mohon upload file gambar (JPG/PNG).');
                    return;
                }

                selectedFile = file;
                previewUrl = URL.createObjectURL(file);

                // Langsung lanjut ke preview
                showPreviewStage();
            }
        }

        // --- PREVIEW / CONFIRMATION ---
        function showPreviewStage() {
            updateProgress(3); // Dianggap tahap konfirmasi
            const stageContent = document.getElementById('stageContent');
            stageContent.innerHTML = `
                <div class="fade-in-up" style="display:flex; flex-direction:column; align-items:center;">
                    <div class="preview-container">
                        <img src="${previewUrl}" class="image-preview" alt="Preview">
                    </div>
                    <h4 style="margin-top:20px; color:#444;">Apakah foto sudah jelas?</h4>
                    <div style="display:flex; gap:15px;">
                        <button class="action-btn btn-secondary" onclick="resetToStage1()">Ulangi</button>
                        <button class="action-btn btn-primary" onclick="processImage()">
                            <i class="fas fa-search"></i> Analisis Sekarang
                        </button>
                    </div>
                </div>
            `;
        }

        function resetToStage1() {
            updateProgress(1);
            document.getElementById('stageContent').innerHTML = `
                <div id="stage1" class="fade-in-up" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                    <h3 style="margin-bottom: 30px; color: #6B4226;">Pilih Metode Pengambilan Gambar</h3>
                    <div class="selection-grid">
                        <div class="selection-card" onclick="selectMethod('camera')">
                            <div class="selection-icon"><i class="fas fa-camera"></i></div>
                            <div class="selection-title">Gunakan Kamera</div>
                            <div class="selection-desc">Ambil foto langsung dari kamera perangkatmu</div>
                        </div>
                        <div class="selection-card" onclick="selectMethod('upload')">
                            <div class="selection-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                            <div class="selection-title">Upload File</div>
                            <div class="selection-desc">Pilih foto dari galeri (JPG/PNG)</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- CONNECT TO API ---
        async function processImage() {
            if (!selectedFile) return;

            // Loading UI
            const stageContent = document.getElementById('stageContent');
            stageContent.innerHTML = `
                <div class="fade-in-up" style="text-align: center; padding:40px;">
                    <div style="width: 60px; height: 60px; border: 5px solid #f3f3f3; border-top: 5px solid #D4A373; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    <h3 style="color: #6B4226; margin-top: 20px;">AI Sedang Berpikir...</h3>
                    <p style="color: #888;">Menganalisis pola wayang</p>
                </div>
            `;

            const formData = new FormData();
            formData.append('image', selectedFile);

            try {
                const response = await fetch('/api/predict-wayang', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    showResult(data);
                } else {
                    alert("Error: " + (data.error || "Gagal"));
                    resetToStage1();
                }
            } catch (error) {
                console.error("API Error", error);
                alert("Koneksi Error");
                resetToStage1();
            }
        }

        // --- STAGE 4: RESULT ---
        function showResult(data) {
            updateProgress(4);
            const namaWayang = data.prediksi;
            const confidence = data.confidence;
            const deskripsi = wayangData[namaWayang] || `Tokoh ${namaWayang} berhasil terdeteksi, namun deskripsi detail belum tersedia di database.`;

            const stageContent = document.getElementById('stageContent');
            stageContent.innerHTML = `
                <div class="result-layout fade-in-up">
                    <div class="result-img-wrapper">
                        <img src="${previewUrl}" class="result-img" alt="${namaWayang}">
                    </div>
                    <div class="result-info">
                        <span class="confidence-badge"><i class="fas fa-check-circle"></i> Akurasi: ${confidence}</span>
                        <h2 class="wayang-name">${namaWayang}</h2>
                        <div class="wayang-desc">
                            ${deskripsi}
                        </div>
                        <button class="action-btn btn-primary" onclick="resetToStage1()">
                            <i class="fas fa-redo"></i> Coba Lagi
                        </button>
                    </div>
                </div>
            `;
        }

        // Add Spin Animation
        const style = document.createElement('style');
        style.textContent = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
        document.head.appendChild(style);
    </script>
</body>

</html>